<?require_once("include_login.php");require("config.php");require("code_loadcontent.php");require_once("function_permissions.php");$action = $_REQUEST["action"];if (isset($action)) require ("function_save.php");if (isset($action) && $action=="savetext") {	if (!canedit()) die("Kein Recht zu bearbeiten");	# unabhängig davon müsste es noch einen bild-änder-modus geben:	# bilder hochladen (DONE), drehen(DONE), reihenfolge ändern, löschen	# dabei metadaten ändern nicht vergessen	#die("not implemented");	$timestamp = $_POST["timestamp"];	#$contenttxt[$timestamp] = $_POST["content"];	savecontent($timestamp, $_POST["content"]);	$contentmetadata[$timestamp]["Subject"] = $_POST["subject"];	savemetadata($timestamp, $contentmetadata[$timestamp]);	$infotext = "Eintrag $timestamp wurde gespeichert";}if (isset($action) && $action=="deleteentry") {	if (!canedit()) die("Kein Recht zu bearbeiten");	$timestamp = $_GET["timestamp"];	deleteentry($timestamp);	#foreach ($items as $nr => $itemtimestamp)	#	if ($itemtimestamp == $timestamp)	#		$deletenr = $nr;	#unset($items[$deletenr]);	$infotext = "Eintrag $timestamp wurde gel&ouml;scht";}if (isset($action) && $action=="rotateimage") {	if (!canedit()) die("Kein Recht zu bearbeiten");	$timestamp = $_GET["timestamp"];	$imgfile = $_GET["image"];	$orientation = $_GET["orientation"];	$contentmetadata[$timestamp][$imgfile."_orientation"] = $orientation;	savemetadata($timestamp, $contentmetadata[$timestamp]);	$infotext = "Bild $imgfile wurde gedreht";}if (isset($action) && $action=="deleteimage") {	if (!canedit()) die("Kein Recht zu bearbeiten");	$timestamp = $_GET["timestamp"];	$imgfile = $_GET["image"];		deleteimage($timestamp, $imgfile, $contentmetadata[$timestamp]);	$infotext = "Bild $imgfile wurde gel&ouml;scht";	#foreach ($contentimg[$timestamp] as $nr => $imgfile2)	#	if ($imgfile2 == $imgfile)	#		unset($contentimg[$timestamp][$nr]);}if (isset($action) && $action=="setfiltermode") {	if (!canedit()) die("Kein Recht zu bearbeiten");	$timestamp = $_REQUEST["timestamp"];	$imgfile = $_REQUEST["image"];	$contentmetadata[$timestamp][$imgfile."_filtermode"] = $_REQUEST["filtermode"];	savemetadata($timestamp, $contentmetadata[$timestamp]);	$infotext = "Filtermode f&uuml;r $imgfile wurde gesetzt";}if (isset($action) && $action=="changetimestamp") {	if (!canedit()) die("Kein Recht zu bearbeiten");	$timestamp = $_REQUEST["timestamp"];	$newts_year   = $_REQUEST["newts_year"];	if ($newts_year < 100) $newts_year = 2000+$newts_year;	$newts_month  = $_REQUEST["newts_month"]; 	if (strlen($newts_month == 1)) $newts_month = "0".$newts_month;	$newts_day    = $_REQUEST["newts_day"];   	if (strlen($newts_day == 1)) $newts_day = "0".$newts_day;	$newts_hour   = $_REQUEST["newts_hour"];  	if (strlen($newts_hour == 1)) $newts_hour = "0".$newts_hour;	$newts_minute = $_REQUEST["newts_minute"];	if (strlen($newts_minute == 1)) $newts_minute = "0".$newts_minute;	$newts_second = $_REQUEST["newts_second"];	if (strlen($newts_second == 1)) $newts_second = "0".$newts_second;	$newtimestamp = "$newts_year-$newts_month-$newts_day";	$newtimestamp = $newtimestamp."_$newts_hour-$newts_minute-$newts_second";	if (!preg_match("/^\d{4,4}-\d{2,2}-\d{2,2}_\d{2,2}-\d{2,2}-\d{2,2}$/", $newtimestamp)) {		$infotext = "FEHLER: Formatfehler in $newtimestamp !";		die($infotext);	} else		if (changetimestamp($timestamp, $newtimestamp, $contentmetadata[$timestamp]))			$infotext = "Datum wurde ge&auml;ndert - <a href=\"index.php#$newtimestamp\">Zum Eintrag springen</a>";		else			$infotext = "FEHLER: Datum konnte nicht von $timestamp auf $newtimestamp ge&auml;ndert werden!";}		if (isset($action) && $action=="addimage") {	if (!canedit()) die("Kein Recht zu bearbeiten");	$timestamp = $_REQUEST["timestamp"];	$uploadfile = addimage($timestamp);		$contentimg[$timestamp][] = $uploadfile;	$infotext = "Bild wurde hinzugef&uuml;gt";	#echo 'Here is some more debugging info:';	#print_r($_FILES);}if (isset($action) && $action=="addentry") {	if (!canedit()) die("Kein Recht zu bearbeiten");	$timestamp = $_REQUEST["timestamp"];	$contentmetadata[$timestamp]["Timestamp"] = $timestamp;	$contentmetadata[$timestamp]["Subject"] = "";	savemetadata($timestamp, $contentmetadata[$timestamp]);	$_REQUEST["timestamp"] = $timestamp;	$_GET["timestamp"] = $timestamp;	$_POST["timestamp"] = $timestamp;	$infotext = "Leerer Eintrag angelegt";}if (isset($action) && $action=="savepermissions") {	if (!canedit()) die("Kein Recht zu bearbeiten");	$timestamp = $_REQUEST["timestamp"];	$users_cansee = $_REQUEST["users_cansee"];	$contentmetadata[$timestamp]["cansee"] = join(" ", $users_cansee);	savemetadata($timestamp, $contentmetadata[$timestamp]);	$infotext = "Berechtigungen wurden gespeichert";}if (isset($action) && $action=="moveuploads") {	if (!canedit()) die("Kein Recht zu bearbeiten");	$timestamp = $_REQUEST["timestamp"];	$move_file = $_REQUEST["move_file"];		$format = "jpg";	$c = $contentimg[$timestamp];	$maxnr[$format] = 99;	if (isset($c)){		foreach ($c as $nr => $filename){			if (preg_match('/_(\d+)\.'.$format.'$/', $filename, $OUT)){				$maxnr[$format] = max($OUT[1], $maxnr[$format]);			}		}	}		$format = "flv";	$c = $contentflv[$timestamp];	$maxnr[$format] = 99;	if (isset($c)){		foreach ($c as $nr => $filename){			if (preg_match('/_(\d+)\.'.$format.'$/', $filename, $OUT)){				$maxnr[$format] = max($OUT[1], $maxnr[$format]);			}		}	}		$format = "mp4";	$c = $contentmp4[$timestamp];	$maxnr[$format] = 99;	if (isset($c)){		foreach ($c as $nr => $filename){			if (preg_match('/_(\d+)\.'.$format.'$/', $filename, $OUT)){				$maxnr[$format] = max($OUT[1], $maxnr[$format]);			}		}	}				foreach($move_file as $nr => $file){		if (!preg_match('/\.(jpg|flv|mp4)$/i', $file)){			$infotext = $infotext."FEHLER: Dateiformat wird nicht unterst&uuml;tzt - $file<br>";		} else {			if (!preg_match('/^'.preg_quote($uploadpath, "/").'.+\.([^\.]+)$/', $file, $OUT)){				$infotext = $infotext."FEHLER: Datei nicht im Uploadpfad - $file<br>";			} else {				$format = strtolower($OUT[1]);				$newname = $contentprefix.$timestamp."_".($maxnr[$format]+1).".".$format;				$maxnr[$format]++;				if (!is_file($file)){					$infotext = $infotext."FEHLER: Datei existiert nicht - $file<br>";				} else if (!rename($file, $contentpath.$newname)){					$infotext = $infotext."FEHLER: Konnte Datei nicht verschieben - $file<br>";				} else {					$infotext = $infotext."Datei angeh&auml;ngt - $file<br>";				}			}		}	}		#$infotext = "Dateien wurden angeh&auml;ngt";}if (isset($action) && !isset($infotext))	die("unbekannte action $action");if (isset($action) && isset($infotext))	require("code_loadcontent.php");	$view = $_REQUEST["view"];if($view == "edit"){	include("view_edit.php");} else if ($view == "editimage"){	include("view_editimage.php");} else if ($view == "edittimestamp"){	include("view_edittimestamp.php");} else if ($view == "editpermissions"){	include("view_editpermissions.php");} else if ($view == "showimage"){	include("view_showimage.php");} else if ($view == "slideshow"){	include("view_slideshow.php");} else if ($view == "upload"){	include("view_upload.php");} else if ($view == "listimages"){	include("view_listimages.php");} else {	include("view_simple2.php");}?>